namespace = nda_base

nda_base.1 = { # An Introduction to NDA
	type = country_event
	placement = ROOT
	title = nda_base.1.t
	desc = nda_base.1.d
	flavor =  nda_base.1.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/southamerica_war_civilians.bk2"	
	}

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/southamerica/war_civilians"

	icon = "gfx/interface/icons/event_icons/event_nda_cthulhu.dds" #event_fire.dds"

	trigger = {
		has_global_variable = nda_is_loaded # use this here to stop error log entry - event is direct call, not on_action, so no harm done
	}

	option = { #So it begins
		name = nda_base.1.a
		default_option = yes
	}
}

nda_base.2 = { # Nameless Cults published
	type = country_event
	placement = p:x2101E0 #ROOT
	title = nda_base.2.t
	desc = nda_base.2.d
	flavor =  nda_base.2.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/unspecific_politicians_arguing.bk2"		
	}

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/southamerica/war_civilians"

	icon = "gfx/interface/icons/event_icons/tutorial_icon.dds"

	trigger = {
 		# 1839 and owner of dusseldorf
		game_date >= 1839 
		game_date < 1840
		p:x2101E0 = { state = { owner = ROOT } }

		NOT = {has_global_variable = nda_nameless_cults_exists}
	}

	cooldown = { months = 12 }

	immediate = {
		set_global_variable = nda_nameless_cults_exists

		# set target countries for intial YIG and DGN expansions - needed to give competition to sole potential countries
		random_country = {
			limit = {
				country_rank >= rank_value:unrecognized_regional_power	
				
				NOT = { has_variable = nda_nameless_cults_selected }
				any_scope_state = { 
					is_potentially_yigian = yes
				}
			}

			set_variable = nda_nameless_cults_selected
		}
		random_country = {
			limit = {
				country_rank >= rank_value:unrecognized_regional_power	

				NOT = { has_variable = nda_nameless_cults_selected }
				any_scope_state = { 
					is_potentially_yigian = yes
				}
			}

			set_variable = nda_nameless_cults_selected
		}
		random_country = {
			limit = {
				country_rank >= rank_value:unrecognized_regional_power	

				NOT = { has_variable = nda_nameless_cults_selected }
				any_scope_state = { 
					is_potentially_dagonic = yes
				}
			}

			set_variable = nda_nameless_cults_selected
		}
		random_country = {
			limit = {
				country_rank >= rank_value:unrecognized_regional_power					

				NOT = { has_variable = nda_nameless_cults_selected }
				any_scope_state = { 
					is_potentially_dagonic = yes
				}
			}

			set_variable = nda_nameless_cults_selected
		}
		random_country = {
			limit = {
				country_rank >= rank_value:unrecognized_regional_power					

				NOT = { has_variable = nda_nameless_cults_selected }
				any_scope_state = { 
					is_potentially_dagonic = yes
				}
			}

			set_variable = nda_nameless_cults_selected
		}
	}	
	
	option = { #"What harm can a book do?"
		name = nda_base.2.a
		default_option = yes
		
		ai_chance = { # will +ve effect conversion rate
			base = 80		
		}

		# annoy the clergy
		ig:ig_devout = {
			add_modifier = {
	            name = permitted_obscene_publication
	            months = 36
	        }
		}

		# the intellectuals approve
		ig:ig_intelligentsia = {
			add_modifier = {
	            name = championed_free_speech
	            months = 36
	        }
		}
		set_variable = nda_nameless_cults
	}

	option = { #"Such writings must be supressed!"
		name = nda_base.2.b

		ai_chance = { # will -ve effect conversion rate
			base = 20		
		}

		# annoy the intelectuals
		ig:ig_intelligentsia = {
			add_modifier = {
	            name = curtailed_free_speech
	            months = 36
	        }
		}
		# the church approves
		ig:ig_devout = {
			add_modifier = {
	            name = stopped_obscene_publication
	            months = 36
	        }
		}
		set_variable = nda_nameless_cults_supressed
	}
}

nda_base.3 = { # Imprint of Nameless Cults - as above but for other major countries 
	type = country_event
	placement = ROOT
	title = nda_base.3.t
	desc = nda_base.3.d
	flavor =  nda_base.3.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/unspecific_politicians_arguing.bk2"
		
	}

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/southamerica/war_civilians"

	icon = "gfx/interface/icons/event_icons/tutorial_icon.dds"

	trigger = {
 		# 1840 and not dusseldorf
		game_date >= 1840
		has_global_variable = nda_nameless_cults_exists

		NOT = { has_variable = nda_nameless_cults_decision } # don't rerun while decision in progress

		OR = { # will also fire for countries as they promote in rank
			country_rank = rank_value:great_power
			country_rank = rank_value:major_power
			AND = { # Alway for New England
				exists = c:NEN
				c:NEN = ROOT
			}

			# random countries previously selected in yigian lands to rival brazil and also in dagonic shores
			has_variable = nda_nameless_cults_selected
		}

		# redundant to spread to cult country
		NOT = {
			is_full_cult_country = { COUNTRY="ROOT" }				
		}
	}
	
	immediate = {
		set_variable = nda_nameless_cults_decision # don't set immediate as causes follow on event to trigger simultaniously	
		debug_log = "Imprint of Nameless Cults : [THIS.GetCountry.GetNameNoFormatting]" 
	}	
	
	option = { #"What harm can a book do?"
		name = nda_base.3.a
		default_option = yes
		
		ai_chance = { # will +ve effect conversion rate
			base = 75				
		}

		# annoy the clergy
		ig:ig_devout = {
			add_modifier = {
	            name = permitted_obscene_publication
	            months = 36
	        }
		}

		# the intellectuals approve
		ig:ig_intelligentsia = {
			add_modifier = {
	            name = championed_free_speech
	            months = 36
	        }
		}

		set_variable = nda_nameless_cults
	}

	option = { #"Such writings must be supressed!"
		name = nda_base.3.b

		ai_chance = { # will -ve effect conversion rate
			base = 25
			
			modifier = {
				trigger = {
					EXISTS = c:RUS # RUS is forming ELD far too frequent - Try Nerf by delaying spread - TODO? base on lit rate not just country?
					c:RUS = THIS					
				}
				add = 65
			}
		}

		# annoy the intellectuals
		ig:ig_intelligentsia = {
			add_modifier = {
	            name = curtailed_free_speech
	            months = 36
	        }
		}
		# the church approves
		ig:ig_devout = {
			add_modifier = {
	            name = stopped_obscene_publication
	            months = 36
	        }
		}

		set_variable = nda_nameless_cults_supressed
	}
}

nda_base.4 = { # The Death of Junzt
	type = country_event
	placement = p:x2101E0 #ROOT
	title = nda_base.4.t
	desc = nda_base.4.d
	flavor =  nda_base.4.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/unspecific_vandalized_storefront.bk2"
		
	}
	#event_image = {  texture = "gfx/event_pictures/event1.dds"  }

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/southamerica/war_civilians"

	icon = "gfx/interface/icons/event_icons/event_skull.dds"

	trigger = {
 		# 1841 - msg to all players
		game_date >= 1841
		game_date < 1842 # Can clear variables out after this date ?
		has_global_variable = nda_nameless_cults_exists
	}

	cooldown = { months = 12 }

	immediate = {

	}	
	
	option = { #So it begins
		name = nda_base.4.a
		default_option = yes
	}
}

# Cultist in government - mostly hidden?
nda_base.5 = { # First Cultist in Country
	type = country_event
	placement = ROOT
	title = nda_base.5.t
	desc = { 
		first_valid = {
			triggered_desc = {
				trigger = {
					scope:converted_ig.leader = { has_variable = nda_cured_by_cult }
				}
				desc = nda_base.5.d2 
			}
			desc = nda_base.5.d
		}
	}
	flavor =  nda_base.5.f

	duration = 3

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/misc/1Character_Banner"

	icon = "gfx/interface/icons/event_icons/event_skull.dds"

	#event_image = {  texture = "gfx/event_pictures/event1.dds"  } # dummy image

	gui_window = event_window_1char_tabloid

	left_icon = scope:converted_ig.leader

	trigger = {
		OR = {
			has_variable = nda_nameless_cults
			AND = {
				has_variable = nda_nameless_cults_supressed 		
				has_global_variable = nda_cultists_in_open	# delay till a country is converted
			}
		}

		can_cult_infiltrate = yes
	}

	immediate = {
		# set ig leader character to be Cultist - exclude devout initially?
		ordered_interest_group = {
			limit = { 
				NOT = { is_interest_group_type = ig_devout } 
				NOT = { leader = { has_trait = nda_investigator } }
			}	
			order_by = nda_leader_cult_potential
			max = 1

			leader = { 
				add_trait = nda_cultist
				# perks of the cult 
				nda_effect_cult_perks = yes

				save_scope_as = converted_ig_leader
			}
			save_scope_as = converted_ig					
		}

		# start journal for initial cult spread
		if = {
			limit = {
				can_cult_infiltrate = yes

				NOT = {is_full_cult_country = { COUNTRY="ROOT"}} # don't do for existing bad guys
			}
			add_journal_entry = { type = je_nda_cult_spreads }		
		}

		debug_log_scopes = no				
	}	
	
	option = { #"What can we do"
		name = nda_base.5.a
		default_option = yes
	}
}

nda_base.6 = { # Secret Cultists in Country - only fired from journals: je_nda_cult_spreads - since there may be no target this should be hidden and only call visible event if valid
	type = country_event
	hidden = yes 

	trigger = {
		#should prevent assignment if all ig already has cultist+ ?
	}

	immediate = {
		# set ig leader character to be Cultist - exclude devout initially?
		ordered_interest_group = {
			limit = { 
				NOT = { 
					leader = { 
						OR  = {
							has_any_cultist_trait = yes	
							has_trait = nda_investigator # exclude investigators						
						}

					} 
				}
			}
			order_by = nda_leader_cult_potential
			max = 1

			leader = { 
				add_trait = nda_cultist 
				# perks of the cult 
				nda_effect_cult_perks = yes

				save_scope_as = converted_ig_leader
			}
			save_scope_as = converted_ig	
		}	
		# if scope converted_ig_leader does not exist don't call
		if = { 
			limit = { exists = scope:converted_ig_leader }
			trigger_event = { id = nda_base.12 }	
		}
	}	

}

nda_base.7 = { # The Cult in power - called from journal ' je_nda_cult_spreads' on completion
	type = country_event
	placement = ROOT
	title = nda_base.7.t
	desc = nda_base.7.d
	flavor =  nda_base.7.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/southamerica_war_civilians.bk2"
		
	}
	#event_image = {  texture = "gfx/event_pictures/event1.dds"  }

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/southamerica/war_civilians"

	icon = "gfx/interface/icons/event_icons/event_fire.dds"

	trigger = {

	}

	immediate = {
		if = {
			limit = {
				NOT = { has_variable = nda_cultists_in_open }
			}

			set_variable = nda_cultists_in_open

			# set country to contain cultists.
			add_primary_culture = cu:nda_cul_cultist # Adding Culture allows for Leaders of Culture despite no pop present!
			# set country states as homeland, convert % of pops to religion?
			every_scope_state = {
				state_region = {
					add_homeland = cu:nda_cul_cultist
				}

				if = { limit = { is_capital = yes }  # boost in capital
					convert_population = { target = rel:nda_rel_cultist value = 0.05 }			
				}
				else = {
					convert_population = { target = rel:nda_rel_cultist value = 0.02 }
				}
					
				set_variable = { # ongoing conversion
					name = nda_rel_boost_eldritch_cult
					months = 12
					value = nda_small_conversion
				}
			}

			# notify players of change
			save_scope_as = originator

			every_country = {
				limit = { is_player = yes }
				this = {
					post_notification = nda_first_open_cult # this is not noticable (like most notices) go back to event ?					
				}
			}
			
			set_global_variable = nda_cultists_in_open	

			# if ELD exists offer an obligation if lesser ranked
			IF = {
				limit = {
					exists = c:ELD
					c:ELD = { country_rank > root.country_rank }
					NOT = { owes_obligation_to = c:ELD }
				}

				debug_log = "Offer Obligation to ELD on becoming Cultist : [THIS.GetCountry.GetNameNoFormatting]" #[ROOT.GetName] : 

				set_owes_obligation_to = { country = c:ELD setting = yes }
				change_relations = { country = c:ELD value = 50 } # 30 was too low?				
			}

			# Need to try and spread further so pass off to a non-cultist neighbour
			random_country = {
				limit = {
					is_adjacent_to_country = ROOT
					can_cult_infiltrate = yes
				}
				trigger_event = { id = nda_base.8 }	# spread the cult
			}

			# exile a non-cultist politician character if they exist
			ordered_scope_character = {
				limit = { 
					is_ruler = no
					has_role = politician
					has_any_cultist_trait = no
				}
				order_by = { 
					add = 1
					if = {
						limit = {
							interest_group = { is_powerful = yes }							
						}
						add = 2
					}
					if = {
						limit = { is_historical = yes }
						add = 3
					}
					if = {
						limit = { has_trait = nda_investigator } # plot armour
						add = 2
					}
				}
				max = 1
				save_scope_as = exiled_ig_leader
				
			}
	
			IF = {
				limit = { exists = scope:exiled_ig_leader }
				scope:exiled_ig_leader = {
					#exile_character = yes
					hidden_effect = {
						if = {
							limit = {
								NOT = { has_role = agitator }
							}
							add_character_role = agitator
						}
						if = {
							limit = {
								has_role = general
							}
							remove_character_role = general
						}
						if = {
							limit = {
								has_role = admiral
							}
							remove_character_role = admiral
						}
						if = {
							limit = {
								has_role = politician
							}
							set_as_interest_group_leader = no
							remove_character_role = politician
						}
						if = {
							limit = {
								NOT = { has_trait = nda_investigator }
								
							}
							add_trait = nda_investigator # has a grudge against the cult!
						}
					}
	
					exile_character_with_martyrdom = yes
					
					debug_log = "[THIS.GetCountry.GetNameNoFormatting] - Non-cult IG Leader exiled"
					debug_log_scopes = no
				}			
			}
		}		
	}	
	
	option = { #So it begins
		name = nda_base.7.a
		default_option = yes
	}
}

nda_base.8 = { # Neigbouring country has spread cult to us
	type = country_event
	placement = ROOT
	title = nda_base.8.t
	desc = nda_base.8.d
	flavor =  nda_base.8.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/southamerica_war_civilians.bk2"
		
	}
#	#event_image = {  texture = "gfx/event_pictures/event1.dds"  }

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/southamerica/war_civilians"

	icon = "gfx/interface/icons/event_icons/event_fire.dds"

	trigger = {
		
	}

	immediate = {
		# start journal for additional cult spread
		if = {
			limit = {
				can_cult_infiltrate = yes
			}
			debug_log = "Cult Expanded from Neighbour : [THIS.GetCountry.GetNameNoFormatting]" #[ROOT.GetName] : 
			#debug_log_scopes = no
			add_journal_entry = { type = je_nda_cult_spreads }	
				
		}
	}	
	
	option = { #Hurrah!
		name = nda_base.8.a
		default_option = yes
	}
}


nda_base.9 = { # Is there some non-conformists within the cult
	type = country_event
	placement = ROOT
	title = nda_base.9.t
	desc = nda_base.9.d
	flavor =  nda_base.9.f

	duration = 3

	gui_window = event_window_1char_tabloid

	left_icon = scope:targeted_ig_leader # converted_ig.leader

	trigger = {
		is_full_cult_country = { COUNTRY="ROOT" }

		any_interest_group = {
			leader = { 
				has_any_cultist_trait = yes
				has_non_cultist_ideology = yes
			} 
			NOT = { is_interest_group_type = ig_devout } # 'free' devout should be resistant 		
		}		
	}

	immediate = {
		random_interest_group = {
			limit = { 
				leader = { 
					has_any_cultist_trait = yes
					has_non_cultist_ideology = yes
				} 
				
				NOT = { is_interest_group_type = ig_devout } # 'free' devout should be resistant 
			}
			leader = {
				save_scope_as = targeted_ig_leader
			}
			save_scope_as = targetted_ig	
		}

		debug_log = "Check for Non-Conformists" 				

	}	
	
	option = { #Persuade Them!
		name = nda_base.9.a
		default_option = yes
		
		ai_chance = { # should be most likely
			base = 100		
		}

		# have chance of traditionalist as well?
		scope:targeted_ig_leader = { 
			nda_effect_ensure_cult_ideology = yes	
		} 
		debug_log = "Check for Non-Conformists - Persuaded" 	
		debug_log_scopes = yes
		# rdeuce radicals in IG as well? Change Anger?
	}	

	option = { #Ignore Them! # For Players only ?
		name = nda_base.9.b

		ai_chance = { # should be never
			base = 0		
		}
	}
}

nda_base.10 = { # Notifications that the Eldritch Realms hs formed
	type = country_event
	#hidden = yes # if there are no option, make it hidden
	placement = ROOT
	title = nda_base.10.t
	desc = nda_base.10.d
	flavor =  nda_base.10.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/southamerica_war_civilians.bk2"	
	}

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/southamerica/war_civilians"

	icon = "gfx/interface/icons/event_icons/event_fire.dds"

	trigger = {
		AND = {
				exists = c:ELD
				c:ELD = ROOT
		}
		NOT = { has_global_variable = nda_eldritch_realm_founded} 
	}

	immediate = {

		set_global_variable = nda_eldritch_realm_founded

		# send out notification		
		every_country = {
			limit = {
				#is_player = yes
				NOT = {	c:ELD = ROOT }
			}

			post_notification = nda_elditch_realm_proclaimed # toast

		}

		# set up Leaders and IG's
		nda_effect_eldritch_setup = yes

		# spread to non-cultist  Neighbour
		random_country = {
			limit = {
				is_adjacent_to_country = ROOT
				can_cult_infiltrate = yes
			}
			trigger_event = { id = nda_base.8 }	# spread the cult
		}

		# trigger events for other cult countries to bow down/offer tribute/ignore

	}	
	
	option = { # #Hurrah!
		name = nda_base.10.a
		default_option = yes
	}
}

nda_base.12 = { # Secret Cultists in Country - fired from event nda_base.6 called by journals: je_nda_cult_spreads
	type = country_event
	placement = ROOT
	title = nda_base.12.t
	

	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					scope:converted_ig_leader = {
						has_variable = nda_repented # if already repented then they have gone back on their word
					}
				}
				desc = nda_base.12.u
			}
			triggered_desc = {
				trigger = {
					scope:converted_ig.leader = { 
						has_variable = nda_cured_by_cult # cured by the cult
					}
				}
				desc = nda_base.12.d2 
			}

			desc = nda_base.12.d

		}
	}

	flavor =  nda_base.12.f

	duration = 3

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/misc/1Character_Banner"

	icon = "gfx/interface/icons/event_icons/event_skull.dds"
	
	gui_window = event_window_1char_tabloid

	left_icon = scope:converted_ig_leader

	trigger = {

	}

	immediate = {
		# set ig leader character to be Cultist - already done by calling event - scoped leader should still be available for text
	}	
	
	option = { #"What can we do"
		name = nda_base.12.a
		default_option = yes
	}
}

nda_base.13 = { # The Cult fails to spread
	type = country_event
	placement = ROOT
	title = nda_base.13.t
	desc = nda_base.13.d
	flavor =  nda_base.13.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/southamerica_war_civilians.bk2"
		
	}
	#event_image = {  texture = "gfx/event_pictures/event1.dds"  }

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/unspecific/world_fair"

	icon = "gfx/interface/icons/event_icons/event_nda_cthulhu.dds" #event_fire.dds"

	trigger = {
		# direct from journal: je_nda_cult_spreads on fail
	}

	immediate = {
		set_variable = nda_cult_spread_failed
		# exile a cultist
		ordered_scope_character = {
			limit = { 
				is_ruler = no
				has_role = politician
				has_any_cultist_trait = yes
			}
			order_by = { 
				add = 1
				if = {
					limit = { has_trait = nda_master }
					add = 3
				}
				if = {
					limit = { has_trait = nda_acolyte }
					add = 1
				}
				if = {
					limit = {
						interest_group = { is_powerful = yes }							
					}
					add = 2
				}
				if = {
					limit = { is_historical = yes }
					add = 5
				}
			}
			max = 1
			save_scope_as = exiled_ig_leader
			
		}

		IF = {
			limit = { exists = scope:exiled_ig_leader }
			scope:exiled_ig_leader = {
				#exile_character = yes
				hidden_effect = {
					if = {
						limit = {
							NOT = { has_role = agitator }
						}
						add_character_role = agitator
					}
					if = {
						limit = {
							has_role = general
						}
						remove_character_role = general
					}
					if = {
						limit = {
							has_role = admiral
						}
						remove_character_role = admiral
					}
					if = {
						limit = {
							has_role = politician
						}
						set_as_interest_group_leader = no
						remove_character_role = politician
					}
				}

				exile_character_with_martyrdom = yes
			}			
		}

	}	
	
	option = { #We will be waiting
		name = nda_base.13.a
		default_option = yes

		nda_effect_eldritch_anger = yes
		ai_chance = { # should be most likely if available
			base = 30		
		}
	}
	option = { #May be your right
		name = nda_base.13.b
		
		# remove fail variable - should allow retrigger of journal
		set_variable = { # can't just remove as causes error if details of failed journal still displayed 'current_value'
			name = nda_cult_spread_tracker
			value = 0
		}	
		remove_variable = nda_cult_spread_failed	

		ai_chance = { # should be most likely if available
			base = 10		
		}
	}
	option = { # Yours is a failed philosophy 
		# Cthulhu is gone so no response from despondent cultists
		name = nda_base.13.c
		trigger = { has_global_variable = nda_ritual_cthulhu_leaves }
		ai_chance = { # should be most likely if available
			base = 200		
		}		
	}
}

nda_base.14 = { # Revolt Cultist Countries have flags removed - reinstate them - update changed this so it does not trigger using nda_cultists_in_open
	type = country_event
	hidden = yes 

	trigger = {
		is_full_cult_country = { COUNTRY="THIS" } # any full cult country
		#NOT = { has_variable = nda_cultists_in_open }
		any_interest_group = {
			has_ideology = ideology:ideology_anti_slavery # ideologies have been reset by revolt
		}
	}

	immediate = {
		set_variable = nda_cultists_in_open
		set_variable = {
			name = nda_cult_spread_tracker
			value = 1101
		}

		if = { # Eldritch only
			limit = { 				
				exists = c:ELD
				c:ELD = ROOT 
			}

			# Set up Eldritch leadership and IGs
			nda_effect_eldritch_setup = yes
		}
		else_if = { # Yigian only
			limit = { 				
				exists = c:YIG
				c:YIG = ROOT 
			}

			set_variable = nda_yig_in_open
			set_variable = {
				name = nda_cult_to_yigian_tracker
				value = 301
			}

			# Set up Yigian leadership and IGs
			nda_effect_yigian_setup = yes
		}
		else_if = { # Dagonic only
		
			limit = { 				
				exists = c:DGN
				c:DGN = ROOT 
			}

			set_variable = nda_dagon_in_open
			set_variable = {
				name = nda_cult_to_dagonic_tracker
				value = 301
			}

			# Set up Dagonic leadership and IGs
			nda_effect_dagonic_setup = yes
		}
		else_if = { # Stygia only		
			limit = { 				
				exists = c:STY
				c:STY = ROOT 
			}

			set_variable = nda_yig_in_open
			set_variable = {
				name = nda_cult_to_yigian_tracker
				value = 301
			}

			# Set up Stygian leadership and IGs
			nda_effect_stygian_setup = yes
		}
	}	
}

nda_base.15 = { # Is there non-conformists leader within the cult
	type = country_event
	placement = ROOT
	title = nda_base.15.t
	desc = nda_base.15.d
	flavor =  nda_base.15.f

	duration = 3

	gui_window = event_window_1char_tabloid

	left_icon = scope:targeted_ig_leader # converted_ig.leader

	trigger = {
		exists = ig:ig_nda_cult_worshippers
		ig:ig_nda_cult_worshippers = {
			leader ?= { 
				has_any_cultist_trait = yes
				has_non_cultist_ideology = yes
			} 
		}		
	}

	immediate = {
		ig:ig_nda_cult_worshippers = {
			leader = { 
				save_scope_as = targeted_ig_leader
				nda_effect_ensure_cult_ideology = yes					
			} 
		}

		debug_log = "Check for Non-Conformist Cult Leader" 				

	}	
	
	option = { # To be expected
		name = nda_base.15.a
		default_option = yes
		
		ai_chance = { # should be most likely
			base = 100		
		}

		debug_log = "Non-Conformist Cult Leader - Persuaded" 	

	}	
}


nda_base.20 = { # Request from the devout
	type = country_event
	placement = ROOT
	title = nda_base.20.t
	desc = nda_base.20.d
	flavor =  nda_base.20.f

	duration = 3

	# should be character block
	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/misc/1Character_Banner"

	icon = "gfx/interface/icons/event_icons/event_scales.dds" #icon = "gfx/interface/icons/event_icons/event_nda_cthulhu.dds" 

	#event_image = {  texture = "gfx/state_pictures/arctic.dds"  } # dummy image

	gui_window = event_window_1char_tabloid

	left_icon = scope:devout_ig_leader

	trigger = {

		OR = {
			is_player = yes
			AND = {
				exists = c:NEN
				c:NEN = ROOT
			}
		}

		# redundant to spread to cult country
		NOT = {
			is_full_cult_country = { COUNTRY="ROOT" }				
		}	
		NOT = { has_variable = nda_devout_offer }

		AND = {
			has_journal_entry = je_nda_cult_spreads
			var:nda_cult_spread_tracker > 5 # Don't do immediate pop-up			
		}

		any_interest_group = { # from devout only
			is_interest_group_type = ig_devout 
			leader = { has_any_cultist_trait = no } # must be 'clean'
		}
	}

	immediate = {
		set_variable = nda_devout_offer

		random_interest_group = { # from devout only
			limit = { 
				is_interest_group_type = ig_devout 
				leader = { has_any_cultist_trait = no }
			}
			leader = { 
				save_scope_as = devout_ig_leader
			}
		}

		debug_log = "Devout Offer" 
	}	
	
	option = { #"Inquisition?"
		name = nda_base.20.a

		ai_chance = { # will +ve effect conversion rate
			base = 80		
		}

		add_journal_entry = { type = je_nda_devout_inquisition }
		
		ig:ig_devout = {
			add_modifier = {
				name = nda_inquisition_righteous_modifier # lasts till inqu ends or is rejected
			}			
		}
		ig:ig_intelligentsia = {
			add_modifier = {
				name = nda_inquisition_opposed_modifier # lasts till inqu ends or is rejected
			}
		}
	}

	option = { #"Silly"
		name = nda_base.20.b
		default_option = yes

		ai_chance = { # will +ve effect conversion rate
			base = 20		
		}

		ig:ig_devout = {
			add_modifier = {
				name = rejected_mission
				months = 36
			}			
		}
	}
}

nda_base.21 = { # A cultist targeted 
	type = country_event
	hidden = yes 

	immediate = {
		# set ig leader character to be Cultist - exclude devout initially?
		random_interest_group = {
			limit = {
				NOT = { is_interest_group_type = ig_devout } # Don't include devout as contradicts journal fail condition
				leader = { 
					has_any_cultist_trait = yes
				} 			
			}
			leader = { 
				save_scope_as = targeted_ig_leader
			}
			save_scope_as = targeted_ig
		}	
		# if scope converted_ig_leader does not exist don't call
		if = { 
			limit = { exists = scope:targeted_ig_leader }
			
			if = {
				limit = { scope:targeted_ig_leader = { has_trait = nda_master } }
				# not going to work
				trigger_event = { id = nda_base.23 }	
			}	
			else = {
				trigger_event = { id = nda_base.22 }	
			}		
		}
	}
}

nda_base.22 = { # A Cultist converted 
	type = country_event
	placement = ROOT
	title = nda_base.22.t
	desc = nda_base.22.d
	flavor =  nda_base.22.f

	duration = 3

	# should be character block
	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/misc/1Character_Banner"

	icon = "gfx/interface/icons/event_icons/event_scales.dds" #icon = "gfx/interface/icons/event_icons/event_nda_cthulhu.dds" 

	#event_image = {  texture = "gfx/state_pictures/arctic.dds"  } # dummy image

	gui_window = event_window_1char_tabloid

	left_icon = scope:targeted_ig_leader

	trigger = {
		# from nda_base.21 only
	}

	immediate = {
		scope:targeted_ig_leader = {
			# remove traits
			remove_trait = nda_cultist
			remove_trait = nda_acolyte

			set_variable = { name = nda_repented }
		}

		debug_log = "Inquisition - Cult Traits Removed" 
	}	
	
	option = { #"Saw Sense"
		name = nda_base.22.a
		default_option = yes
	}

	option = { #"No forgivness"
		name = nda_base.22.b
		scope:targeted_ig_leader = {
				kill_character = yes
		}
	}
}

nda_base.23 = { # A Cultist refuses 
	type = country_event
	placement = ROOT
	title = nda_base.23.t
	desc = nda_base.23.d
	flavor =  nda_base.23.f

	duration = 3

	# should be character block
	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/misc/1Character_Banner"

	icon = "gfx/interface/icons/event_icons/event_nda_cthulhu.dds"

	#event_image = {  texture = "gfx/state_pictures/arctic.dds"  } # dummy image

	gui_window = event_window_1char_tabloid

	left_icon = scope:targeted_ig_leader

	trigger = {
		# from nda_base.21 only
	}

	immediate = {
		debug_log = "Inquisition - Cultist Refuses" 
	}	
	
	option = { #"Oh dear."
		name = nda_base.23.a
	}
}

nda_base.24 = { # The Inquisition ends 
	type = country_event
	placement = ROOT
	title = nda_base.24.t
	desc = nda_base.24.d
	flavor =  nda_base.24.f

	duration = 3

	# should be character block
	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/misc/1Character_Banner"

	icon = "gfx/interface/icons/event_icons/event_scales.dds" #icon = "gfx/interface/icons/event_icons/event_nda_cthulhu.dds" 

	gui_window = event_window_1char_tabloid

	left_icon = scope:devout_ig_leader

	trigger = {
		# from je_nda_devout_inquisition only
	}

	immediate = {
		random_interest_group = { # from devout only
			limit = { 
				is_interest_group_type = ig_devout 
			}
			leader = { 
				save_scope_as = devout_ig_leader
			}
			if = { limit = { has_modifier = nda_inquisition_righteous_modifier }
				remove_modifier = nda_inquisition_righteous_modifier
			}
		}

		every_interest_group = {
			limit = { 					
				has_modifier = nda_inquisition_opposed_modifier
			}
			remove_modifier = nda_inquisition_opposed_modifier
		}

		debug_log = "Inquisition - Ends" 
	}	
	
	option = { #"Oh dear."
		name = nda_base.24.a
	}
}


nda_base.25 = { # An Innocent condemned 
	type = country_event
	placement = ROOT
	title = nda_base.22.t #same descriptions as gulity!
	desc = nda_base.22.d
	flavor = nda_base.22.f

	duration = 3

	# should be character block
	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/misc/1Character_Banner"

	icon = "gfx/interface/icons/event_icons/event_scales.dds" #icon = "gfx/interface/icons/event_icons/event_nda_cthulhu.dds" 

	gui_window = event_window_1char_tabloid

	left_icon = scope:targeted_ig_leader

	trigger = {
		# from nda_base.21 only
	}

	immediate = {
		random_interest_group = {
			limit = { 				
				leader = { 
					has_any_cultist_trait = no
				} 	
				NOT = { is_interest_group_type = ig_devout } # Don't include devout	
			}
			leader = { 				
				save_scope_as = targeted_ig_leader
			}
			save_scope_as = targeted_ig
		}	

		# possibility of negative trait due to torture
		random_list = {	
			25 = { } 
			25 = { scope:targeted_ig_leader = { add_trait = alcoholic } }
			25 = { scope:targeted_ig_leader = { add_trait = psychological_affliction } }
			25 = { scope:targeted_ig_leader = { add_trait = opium_addiction } }
		}		
	
		debug_log = "Inquisition - Innocent persecuted" 
		set_variable = "nda_innocent_condemmed"
	}	
	
	option = { #"Saw Sense"
		name = nda_base.22.a
		default_option = yes
	}

	option = { #"No forgivness"
		name = nda_base.22.b
		scope:targeted_ig_leader = {
				kill_character = yes
		}
	}
}

nda_base.26 = { # The Pit and the Pendulum!
	type = country_event
	placement = ROOT
	title = nda_base.26.t 
	desc = nda_base.26.d
	flavor =  nda_base.26.f

	duration = 3

	# should be character block
	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/misc/1Character_Banner"

	icon = "gfx/interface/icons/event_icons/event_scales.dds" #icon = "gfx/interface/icons/event_icons/event_nda_cthulhu.dds" 

	gui_window = event_window_2char

	left_icon = scope:targeted_ig_leader
	right_icon = scope:devout_ig_leader
	trigger = {
		
	}

	weight_multiplier = {
		base = 0
		modifier = {
			has_variable = nda_innocent_condemmed
			add = 10
		}
	}

	cooldown = { months = 4 } # stop repeat while still open

	immediate = {
		random_interest_group = {
			limit = { 				
				leader = { 
					has_any_cultist_trait = no
				} 	
				NOT = { is_interest_group_type = ig_devout } # Don't include devout	
			}
			leader = { 				
				save_scope_as = targeted_ig_leader
			}
			save_scope_as = targeted_ig
		}	
		random_interest_group = { # devout leader
			limit = { 
				is_interest_group_type = ig_devout 
			}
			leader = { 
				save_scope_as = devout_ig_leader
			}
		}

		debug_log = "Inquisition - Pit and Pendulum" 
	}	
	
	option = { #"We must end this atrocity"
		name = nda_base.26.a
		default_option = yes
		# stop the Inquisition
		custom_tooltip = nda_base_inqusition_closed_tooltip
		hidden_effect = { set_variable = nda_inqusition_closed }

		# bad debuff for devout, inqusition ends
		ig:ig_devout = {
			if = { limit = {has_modifier = nda_inquisition_righteous_modifier }
				remove_modifier = nda_inquisition_righteous_modifier
			}
			add_modifier = {
				name = nda_inquisition_unjust_modifier
				months = 12
				is_decaying = yes				 
			}			
		}

		# exile devout leader - set traits as cultists - a bad apple all along
		scope:devout_ig_leader = {
			add_trait = nda_master
			exile_character = yes
		}

		ig:ig_intelligentsia = {
			if = { limit = {has_modifier = nda_inquisition_opposed_modifier }
				remove_modifier = nda_inquisition_opposed_modifier
			}
			#add_modifier = {
			#	name = nda_inquisition_unjust_modifier
			#}			
		}

		debug_log = "Inquisition - Pit and Pendulum - End Atrocity" 
	}

	option = { #"Mistakes happen"
		name = nda_base.26.b
		# debuff for devout and government
		ig:ig_devout = {
			if = { limit = {has_modifier = nda_inquisition_righteous_modifier }
				remove_modifier = nda_inquisition_righteous_modifier
			}			
		}

		# any opposition gets opposed modifier
		every_interest_group = {
			limit = { 					
				NOT = { 
					is_interest_group_type = ig_devout  # Don't include devout	
					is_in_government = no
				}
			}
			if = { limit = { not = { has_modifier = nda_inquisition_opposed_modifier } }
	
				add_modifier = {
					name = nda_inquisition_opposed_modifier
				}
			}
	
		}

		debug_log = "Inquisition - Pit and Pendulum - Mistakes happen" 
	}
}

# Cult Interactions for when Player is in Cult Country
nda_base.30 = { # Cult is leaderless
	type = country_event
	placement = ROOT
	title = nda_base.30.t
	desc = nda_base.30.d
	flavor =  nda_base.30.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/unspecific_politicians_arguing.bk2"		
	}

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/southamerica/war_civilians"

	icon = "gfx/interface/icons/event_icons/tutorial_icon.dds"

	trigger = {
 		is_player = yes # for players only
		has_variable = nda_cult_leaderless # no leader!
		NOT = { has_variable = nda_cult_leaderless_timer } # for some time
		# Big boss exists else overlord is cultist
		OR = {
			any_overlord_or_above = {
				has_variable = nda_cultists_in_open
				any_scope_character = { # Must have leader to do the complaint
					has_variable = nda_coven_leader
				}
			}
			AND = {
				exists = c:ELD	
				c:ELD = {
					any_scope_character = { # Must have leader to do the complaint
						has_variable = nda_coven_leader
					}
				}				
			}	
		}
	}

	cooldown = { months = 12 }

	immediate = {
		random_country = {
			limit = {
				OR = {
					# is an overlord
					AND = {
						has_variable = nda_cultists_in_open
						has_subject_relation_with = ROOT
						NOT = { is_subject_of = ROOT }						
					}
					# or is big bad
					AND = {
						EXISTS = c:ELD
						THIS = c:ELD						
					}
				}
				any_scope_character = { # Must have leader to do the complaint
					has_variable = nda_coven_leader
				}
			}

			save_scope_as = nda_warning_country

			# get cult leader
			random_scope_character = {
				limit = {
					has_variable = nda_coven_leader
				 }
				 save_scope_as = nda_warning_leader
			}
		}
	
	}	
	
	option = { #"Issue Promise"
		name = nda_base.30.a
		default_option = yes

		set_variable = nda_pander_cults

		set_variable = { # player should assign leader in this time or else 
			name = nda_cult_pander_timer
			months = 3
			value = yes
		}
	}

	option = { #"Defy"
		name = nda_base.30.b

		# annoy the overlord badly
		change_relations = { 
			country = scope:nda_warning_country 
			value = -100 
		}

		# upset local cultists	
		add_radicals = { value = 0.2 religion = rel:nda_rel_cultist } 
		add_radicals = { value = 0.2 culture = cu:nda_cul_cultist }

		set_variable = nda_defy_cults
	}
}

nda_base.31 = { # Pandered to cult but failed to add leader - worse than normal defy
	type = country_event
	placement = ROOT
	title = nda_base.31.t
	desc = nda_base.31.d
	flavor =  nda_base.31.f

	duration = 3

	event_image = {
		video = "gfx/event_pictures/unspecific_politicians_arguing.bk2"		
	}

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/southamerica/war_civilians"

	icon = "gfx/interface/icons/event_icons/tutorial_icon.dds"

	trigger = {
 		is_player = yes # for players only
		has_variable = nda_cult_leaderless # still no leader!
		has_variable = nda_pander_cults
		NOT = { has_variable =  nda_defy_cults} # not really needed but stops log errors
		NOT = { has_variable = nda_cult_pander_timer } # for some time
		# Big boss exists else overlord is cultist
		OR = {
			any_overlord_or_above = {
				has_variable = nda_cultists_in_open
				any_scope_character = { # Must have leader to do the complaint
					has_variable = nda_coven_leader
				}
			}
			AND = {
				exists = c:ELD	
				c:ELD = {
					any_scope_character = { # Must have leader to do the complaint
						has_variable = nda_coven_leader
					}
				}				
			}	
		}
	}

	cooldown = { months = 12 }

	immediate = {
		random_country = {
			limit = {
				OR = {
					# is an overlord
					AND = {
						has_variable = nda_cultists_in_open
						has_subject_relation_with = ROOT
						NOT = { is_subject_of = ROOT }						
					}
					# or is big bad
					AND = {
						EXISTS = c:ELD
						THIS = c:ELD						
					}
				}
				any_scope_character = { # Must have leader to do the complaint
					has_variable = nda_coven_leader
				}
			}

			save_scope_as = nda_warning_country

			# get cult leader
			random_scope_character = {
				limit = {
					has_variable = nda_coven_leader
				 }
				 save_scope_as = nda_warning_leader
			}
		}

		
		# annoy the overlord badly
		change_relations = { 
			country = scope:nda_warning_country 
			value = -200 
		}

		# upset local cultists	
		add_radicals = { value = 0.3 religion = rel:nda_rel_cultist } 
		add_radicals = { value = 0.3 culture = cu:nda_cul_cultist }
	
	}	
	
	option = { #"Too Late Now"
		name = nda_base.31.a
		default_option = yes
	}

}